package de.jeff_media.angelchest.listeners;

import de.jeff_media.angelchest.AngelChestMain;
import de.jeff_media.angelchest.nbt.NBTTags;
import com.jeff_media.jefflib.NBTAPI;
import org.bukkit.Bukkit;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerQuitEvent;

public class InvulnerabilityListener implements Listener {

    public static void removeGod(final Player player) {
        NBTAPI.removeNBT(player, NBTTags.IS_INVULNERABLE);
        final Integer task = AngelChestMain.getInstance().invulnerableTasks.get(player.getUniqueId());
        if (task == null) return;
        Bukkit.getScheduler().cancelTask(task);
        AngelChestMain.getInstance().invulnerableTasks.remove(player.getUniqueId());
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    public void onPlayerDamage(final EntityDamageEvent entityDamageEvent) {
        final Entity entity = entityDamageEvent.getEntity();
        final EntityDamageEvent.DamageCause damageCause = entityDamageEvent.getCause();
        if (damageCause != null) {
            if (damageCause == EntityDamageEvent.DamageCause.VOID || damageCause == EntityDamageEvent.DamageCause.SUICIDE) {
                return;
            }
        }
        if (entity.getType() != EntityType.PLAYER) {
            return;
        }
        final Player player = (Player) entity;
        if (!NBTAPI.hasNBT(player, NBTTags.IS_INVULNERABLE)) {
            return;
        }
        entityDamageEvent.setCancelled(true);
    }

    @EventHandler
    public void onPlayerJoin(final PlayerJoinEvent playerJoinEvent) {
        removeGod(playerJoinEvent.getPlayer());
    }

    @EventHandler
    public void onPlayerQuit(final PlayerQuitEvent playerQuitEvent) {
        removeGod(playerQuitEvent.getPlayer());
    }

}
